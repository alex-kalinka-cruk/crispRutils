---
title: "Mageck vs drugZ comparison using `seqgendiff` to add known signal to the data"
author: "Alex Kalinka"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    depth: 3
    highlight: tango
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
---

# Setup

```{r setup, include=FALSE}
num_reps <- 2

set.seed(1)

options(warn=-1)
suppressMessages(library(knitr))
suppressMessages(library(tidyr))
suppressMessages(library(magrittr))
suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))
suppressMessages(library(seqgendiff))

# Data all from one screen.
c903 <- read.table("../data/HT29_c903.tsv", header=T, stringsAsFactors = F)[,c(1:7)] %>%
  dplyr::select(-ERS717283.plasmid) %>%
  dplyr::filter(rowSums(.[,3:6]) > 30)

# Data from 4 different screens.
cFour <- cbind(read.table("../data/HT29_c905.tsv", header=T, stringsAsFactors = F) %>%
                 select(sgRNA, gene, HT29_c905R4),
               read.table("../data/HT29_c906.tsv", header=T, stringsAsFactors = F) %>%
                 select(HT29_c906R8),
               read.table("../data/HT29_c907.tsv", header=T, stringsAsFactors = F) %>%
                 select(HT29_c907R7),
               read.table("../data/HT29_c908.tsv", header=T, stringsAsFactors = F) %>%
                 select(HT29_c908R6)) %>%
  dplyr::filter(rowSums(.[,3:6]) > 30)

## Common functions.
write_data <- function(data){
  # Write data for algorithms to use.
  write.table(data, file = "bthin_input.txt", col.names = T, row.names = F, sep="\t", quote=F)
}

run_mageck <- function(){
  cmd <- "source ~/miniconda3/bin/activate; mageck test -k bthin_input.txt -t treat.1,treat.2 -c control.1,control.2 -n mageck_out"
  system(cmd)
}

run_drugz <- function(){
  cmd <- "source ~/miniconda3/bin/activate; export PATH=~/git-projects/drugz:$PATH; drugz.py -i bthin_input.txt -c control.1,control.2 -x treat.1,treat.2 -o drugz-out.txt -unpaired"
  system(cmd)
}

read_mageck <- function(){
  return(read.table("mageck_out.gene_summary.txt", header=T, stringsAsFactors = F))
}

read_drugz <- function(){
  return(read.table("drugz-out.txt", header=T, stringsAsFactors = F))
}

# Process output to add expected logFC.
process_output <- function(lfc, type){
  if(type == "mageck"){
    data <- read_mageck()
    gene_col <- "id"
    col.1 <- "neg.fdr"
    col.2 <- "pos.fdr"
  }else{
    data <- read_drugz()
    gene_col <- "GENE"
    col.1 <- "fdr_synth"
    col.2 <- "fdr_supp"
  }
  ret <- data %>%
    mutate(lfc_bthin = ifelse(!!sym(gene_col) %in% names(lfc), 
                              lfc[match(!!sym(gene_col), names(lfc))], 0)) %>%
    rowwise() %>%
    mutate(sign.1 = (!!sym(col.1) < 0.1 || !!sym(col.2) < 0.1),
           # LOD cut-offs for genes to ignore when calculating performance estimates.
           ignore.1.4 = (abs(lfc_bthin) > 0 && abs(lfc_bthin) < 1.4),
           ignore.1.2 = (abs(lfc_bthin) > 0 && abs(lfc_bthin) < 1.2),
           ignore.1 = (abs(lfc_bthin) > 0 && abs(lfc_bthin) < 1),
           ignore.0.8 = (abs(lfc_bthin) > 0 && abs(lfc_bthin) < 0.8),
           ignore.0.6 = (abs(lfc_bthin) > 0 && abs(lfc_bthin) < 0.6),
           ignore.0.4 = (abs(lfc_bthin) > 0 && abs(lfc_bthin) < 0.4),
           ignore.0.2 = (abs(lfc_bthin) > 0 && abs(lfc_bthin) < 0.2),
           ignore.0 = F,
           true_neg = lfc_bthin==0, true_pos = abs(lfc_bthin)>0,
           false_pos = (sign.1 && lfc_bthin==0),
           false_neg = (!sign.1 && abs(lfc_bthin)>0)) %>%
    ungroup()
  return(ret)
}

# Estimate performance.
estimate_performance <- function(data){
  pf <- NULL
  for(i in seq(0,1.4,by=0.2)){
    pf <- rbind(pf,
                data %>%
                  filter(! (!!sym(paste("ignore.",i,sep="")))) %>%
                  summarise(logFC.LOD = i,
                            Specificity = 1-sum(false_pos)/sum(true_neg),
                            Sensitivity = 1-sum(false_neg)/sum(true_pos))
    )
  }
  return(pf)
}

# Randomly sample logFC.
rand_logfc <- function(fun, params, num){
  # Params expected to be in same order as function definition.
  return(fun(num, params[[1]], params[[2]]))
}

# Replicate signal additions.
add_signal_repl <- function(data, num_reps, num_genes, signal_fun, signal_params){
  # data expected to have plasmid column(s) removed in advance.
  ret_sig <- NULL
  ret_perf <- NULL
  for(i in 1:num_reps){
    # 1. Randomly sample genes to receive a signal sampled from a particular distribution.
    lfc <- rand_logfc(signal_fun, signal_params, num_genes)
    names(lfc) <- sample(unique(data$gene), num_genes, replace=F)
    
    # 2. Build coef matrix.
    coef_mat <- as.matrix(data %>%
                        dplyr::select(gene) %>%
                        dplyr::mutate(gene_indicator = ifelse(gene %in% names(lfc),1,0)) %>%
                        dplyr::group_by(gene) %>%
                        dplyr::mutate(gene_indicator = ifelse(gene[1] %in% names(lfc),
                                                              rep(lfc[names(lfc)==gene[1]],n()),
                                                              rep(0,n()))) %>%
                        dplyr::ungroup() %>%
                        dplyr::select(gene_indicator))
    
    # 3. Build design matrix.
    design_cols <- rep(0,4)
    treat_cols <- sample(1:4,2,replace=F)
    design_cols[treat_cols] <- 1
    design_mat <- matrix(design_cols)
    colnames(design_mat) <- "treatment"
    
    # 4. Add signal to randomly sampled genes and their gRNAs.
    thout <- thin_diff(mat = as.matrix(data[,3:ncol(data)]), 
                      design_fixed = design_mat, 
                      coef_fixed = coef_mat)
    
    # 5. Assemble input data for algorithms.
    data_input <- data.frame(data[,1:2], thout$mat, stringsAsFactors = F)
    colnames(data_input)[setdiff(1:4,treat_cols)+2] <- paste("control.",1:2,sep="")
    colnames(data_input)[treat_cols+2] <- paste("treat.",1:2,sep="")
    write_data(data_input)
    
    # 6. Run algorithms.
    run_mageck()
    run_drugz()
    
    # 7. Add expected logFC.
    mageck_out <- process_output(lfc, type = "mageck")
    drugz_out <- process_output(lfc, type = "drugz")
    
    # 8. Estimate performance.
    pf <- rbind(data.frame(Algorithm="Mageck",estimate_performance(mageck_out)),
                data.frame(Algorithm="drugZ",estimate_performance(drugz_out)))
    
    ret_perf <- rbind(ret_perf, pf)
  }
  return(ret_perf)
}

```

```{r}
setwd("../tmp")
```

# Symmetric fold changes

## Prevalence: 10%

### Selection: Strong

```{r}
p10.s <- rbind(data.frame(dataset = "c903", add_signal_repl(c903, num_reps = 2, num_genes = 1800, 
                         signal_fun = rnorm, 
                         signal_params = list(mean = 0, sd = 1.5)), stringsAsFactors = F),
               data.frame(dataset = "cFour", add_signal_repl(cFour, num_reps = 2, num_genes = 1800, 
                         signal_fun = rnorm, 
                         signal_params = list(mean = 0, sd = 1.5)), stringsAsFactors = F))


```

### Selection: Moderate

```{r}
p10.m <- add_signal_repl(c903, num_reps = 2, num_genes = 1800, 
                         signal_fun = rnorm, 
                         signal_params = list(mean = 0, sd = 1))

```

### Selection: Weak

```{r}
p10.w <- add_signal_repl(c903, num_reps = 2, num_genes = 1800, 
                         signal_fun = rnorm, 
                         signal_params = list(mean = 0, sd = 0.5))

```

## Prevalence: 5%

### Selection: Strong

### Selection: Moderate

### Selection: Weak

## Prevalence: 2.5%

### Selection: Strong

### Selection: Moderate

### Selection: Weak

## Prevalence: 1%

### Selection: Strong

### Selection: Moderate

### Selection: Weak

## Prevalence: 0.1%

### Selection: Strong

```{r}
p01.s <- add_signal_repl(c903, num_reps = 2, num_genes = 18, 
                         signal_fun = rnorm, 
                         signal_params = list(mean = 0, sd = 1.5))

```

### Selection: Moderate

### Selection: Weak




# Asymmetric fold changes

## Gaussian

### Prevalence: 10%

#### Selection: Strong

#### Selection: Moderate

#### Selection: Weak

### Prevalence: 5%

#### Selection: Strong

#### Selection: Moderate

#### Selection: Weak

### Prevalence: 2.5%

#### Selection: Strong

#### Selection: Moderate

#### Selection: Weak

### Prevalence: 1%

#### Selection: Strong

#### Selection: Moderate

#### Selection: Weak

### Prevalence: 0.1%

#### Selection: Strong

#### Selection: Moderate

#### Selection: Weak



## Gamma

### Prevalence: 10%

#### Selection: Strong

#### Selection: Moderate

#### Selection: Weak

### Prevalence: 5%

#### Selection: Strong

#### Selection: Moderate

#### Selection: Weak

### Prevalence: 2.5%

#### Selection: Strong

#### Selection: Moderate

#### Selection: Weak

### Prevalence: 1%

#### Selection: Strong

#### Selection: Moderate

#### Selection: Weak

### Prevalence: 0.1%

#### Selection: Strong

#### Selection: Moderate

#### Selection: Weak

